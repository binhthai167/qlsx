{% extends 'production_data/base.html' %}
{% block title %}Báo cáo & Thống kê Sản xuất{% endblock %}
{% block content %}


<div class="card">
    <h2 class="card-header">Báo cáo & Thống kê Sản xuất</h2>
    <!-- Form lọc dữ liệu -->
    <form method="GET" style="display: inline-block; font-size: 0.9rem; margin-bottom: 10px;">
        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
            <label for="id_start_date">Từ:</label>
            <input type="date" id="id_start_date" name="start_date" value="{{ start_date }}" style="width: 130px; padding: 3px; font-size: 0.9rem;">
            <label for="id_end_date">Đến:</label>
            <input type="date" id="id_end_date" name="end_date" value="{{ end_date }}" style="width: 130px; padding: 3px; font-size: 0.9rem;">
        </div>
        <div style="margin-top: 5px; display: flex; gap: 5px;">
            <button class="btn btn-primary" type="submit" style="padding: 3px 8px; font-size: 0.85rem;">Lọc</button>
            <a class="btn btn-secondary" href="{% url 'production_report' %}" style="padding: 3px 8px; font-size: 0.85rem; text-decoration: none; border: 1px solid #ccc; border-radius: 3px; background: #eee; color: #000;">Reset</a>
        </div>
    </form>
    <hr>
    <h3>Tổng hợp Sản lượng</h3>
    <div class="kpi-container" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
    <div class="kpi-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center;">
        <h4 style="margin: 0; font-size: 1rem; color: #6c757d;">Tổng PC Plan</h4>
        <p style="margin: 5px 0 0; font-size: 1.5rem; font-weight: bold; color: #007bff;">{{ grand_totals.overall_total_pc_plan|default:0 }}</p>
    </div>
    <div class="kpi-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center;">
        <h4 style="margin: 0; font-size: 1rem; color: #6c757d;">Tổng PRO Plan</h4>
        <p style="margin: 5px 0 0; font-size: 1.5rem; font-weight: bold; color: #28a745;">{{ grand_totals.overall_total_pro_plan|default:0 }}</p>
    </div>
    <div class="kpi-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center;">
        <h4 style="margin: 0; font-size: 1rem; color: #6c757d;">Tổng Result</h4>
        <p style="margin: 5px 0 0; font-size: 1.5rem; font-weight: bold; color: #dc3545;">{{ grand_totals.overall_total_result|default:0 }}</p>
    </div>
        <div class="kpi-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center;">
        <h4 style="margin: 0; font-size: 1rem; color: #6c757d;">Tổng Giờ chênh lệch</h4>
        <p style="margin: 5px 0 0; font-size: 1.5rem; font-weight: bold; color: #b9ab2e;">{{ grand_totals.overall_total_hour_prod_diff|default:0 }}</p>
    </div>
</div>
    <!-- Biểu đồ và bảng -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
        <!-- Biểu đồ cột lớn bên trái -->
        <div class="chart-container" style="flex: 1; height: 50vh; min-width: 500px;">
            <canvas id="productionSummaryChart"></canvas>
        </div>
        <!-- Biểu đồ tròn nhỏ bên phải -->
        <div class="chart-container" style="width: 300px; height: 300px; flex-shrink: 0;">
            <canvas id="productionPieChart"></canvas>
        </div>
    </div>
    <!-- Nút chọn chế độ hiển thị -->
    <div class="chart-filters">
        <button id="btnProdByGroupModel">Theo Nhóm Model</button>
        <button id="btnProdByType">Theo Model</button>
        <button id="btnProdByDate">Theo Ngày</button>
    </div>
    <!-- Bảng theo Ngày (ẩn mặc định) -->
     <div id="tableProdByDate" class="table-container mb-4 hidden">
    <div id="daily-table-content">
        {% include 'production_data/partials/daily_production_table.html' with daily_production_summary=daily_production_summary %}
    </div>
    </div>

    <div id="tableProdByType" class="table-container mb-4 hidden">
        <div id="type-table-content">
            {% include 'production_data/partials/by_type_production_table.html' with production_by_type_summary=production_by_type_summary sort=sort dir=dir date_filter=date_filter name_filter=name_filter %}
        </div>
    </div>

    <div id="tableProdByGroupModel" class="table-container mb-4">
        <div id="group-model-table-content">
            {% include 'production_data/partials/by_group_model_table.html' with production_by_group_model_summary=production_by_group_model_summary %}
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dữ liệu từ Django context
    const chartDates = JSON.parse('{{ chart_dates|safe }}');
    const chartProdResults = JSON.parse('{{ chart_prod_results|safe }}');
    const chartPcPlans = JSON.parse('{{ chart_pc_plans|safe }}');
    const chartTypeLabels = JSON.parse('{{ chart_type_labels|safe }}');
    const chartTypeProdResults = JSON.parse('{{ chart_type_prod_results|safe }}');
    const chartTypePcPlans = JSON.parse('{{ chart_type_pc_plans|safe }}');
    const modelLabels = JSON.parse('{{ chart_model_labels|safe }}');
    const modelPersonDiffs = JSON.parse('{{ chart_model_person_diffs|safe }}');
    const chartPersonDiffs = JSON.parse('{{ chart_person_diffs|safe }}');
    const chartGroupModelLabels = JSON.parse('{{ chart_group_model_labels|safe }}');
    const chartGroupModelResults = JSON.parse('{{ chart_group_model_results|safe }}');
    const chartGroupModelPcPlans = JSON.parse('{{ chart_group_model_pc_plans|safe }}');


    // Pie Chart Sản lượng theo Nhóm Model
    const pieCtx = document.getElementById('productionPieChart').getContext('2d');
    let pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: chartGroupModelLabels, // Nhãn = nhóm model
            datasets: [{
                label: 'Sản lượng Thực tế',
                data: chartGroupModelResults, // Dữ liệu = số lượng SX thực tế
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: 'white',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Cơ cấu sản lượng theo Nhóm Model'
                },
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed;
                            let total = context.chart._metasets[0].total; // tổng dataset
                            let percentage = ((value / total) * 100).toFixed(1) + "%";
                            return label + ": " + value + " (" + percentage + ")";
                        }
                    }
                }
            }
        }
    });

    function updatePieChart(mode) {
        if (mode === "date") {
            pieChart.data.labels = chartDates;
            pieChart.data.datasets[0].data = chartProdResults;
            pieChart.options.plugins.title.text = "Cơ cấu sản lượng theo Ngày";
        } else if (mode === "group_model") {
            pieChart.data.labels = chartGroupModelLabels;
            pieChart.data.datasets[0].data = chartGroupModelResults;
            pieChart.options.plugins.title.text = "Cơ cấu sản lượng theo Nhóm Model";
        } else if (mode === "type") {
            pieChart.data.labels = chartTypeLabels;
            pieChart.data.datasets[0].data = chartTypeProdResults;
            pieChart.options.plugins.title.text = "Cơ cấu sản lượng theo Model";
        }
        pieChart.update();
    }

    // ===== Chart sản lượng (mặc định theo Nhóm Model) =====
    const prodCtx = document.getElementById('productionSummaryChart').getContext('2d');
    let prodChart = new Chart(prodCtx, {
        type: 'bar',
        data: {
            labels: chartGroupModelLabels,
            datasets: [
                {
                    label: 'Kế hoạch PC',
                    data: chartGroupModelPcPlans,
                    backgroundColor: 'rgba(255, 206, 86, 0.6)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Thực tế SX',
                    data: chartGroupModelResults,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Sản lượng theo Nhóm Model'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Số lượng'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Nhóm Model'
                    }
                }
            }
        }
    });

    function updateProdChart(mode) {
        if (mode === "date") {
            prodChart.data.labels = chartDates;
            prodChart.data.datasets[0].data = chartPcPlans;
            prodChart.data.datasets[1].data = chartProdResults;
            prodChart.options.plugins.title.text = "Sản lượng theo Ngày";
            prodChart.options.scales.x.title.text = "Ngày";
            document.getElementById("tableProdByDate").classList.remove("hidden");
            document.getElementById("tableProdByType").classList.add("hidden");
            document.getElementById("tableProdByGroupModel").classList.add("hidden");
            } else if (mode === "group_model") {
                prodChart.data.labels = chartGroupModelLabels;
                prodChart.data.datasets[0].data = chartGroupModelPcPlans;
                prodChart.data.datasets[1].data = chartGroupModelResults;
                prodChart.options.plugins.title.text = "Sản lượng theo Nhóm Model";
                prodChart.options.scales.x.title.text = "Nhóm Model";
                document.getElementById("tableProdByGroupModel").classList.remove("hidden");
                document.getElementById("tableProdByDate").classList.add("hidden");
                document.getElementById("tableProdByType").classList.add("hidden");
            } else if (mode === "type") {
            prodChart.data.labels = chartTypeLabels;
            prodChart.data.datasets[0].data = chartTypePcPlans;
            prodChart.data.datasets[1].data = chartTypeProdResults;
            prodChart.options.plugins.title.text = "Sản lượng theo Model";
            prodChart.options.scales.x.title.text = "Model";
            document.getElementById("tableProdByType").classList.remove("hidden");
            document.getElementById("tableProdByDate").classList.add("hidden");
            document.getElementById("tableProdByGroupModel").classList.add("hidden");
        }
        prodChart.update();
        updatePieChart(mode);
    }

    // Gán sự kiện cho nút sản lượng
    document.getElementById("btnProdByDate").addEventListener("click", function() {
        updateProdChart("date");
        setActiveBtnProd("btnProdByDate");
    });
    document.getElementById("btnProdByType").addEventListener("click", function() {
        updateProdChart("type");
        setActiveBtnProd("btnProdByType");
    });
    document.getElementById("btnProdByGroupModel").addEventListener("click", function() {
        updateProdChart("group_model");
        setActiveBtnProd("btnProdByGroupModel");
    });

    function setActiveBtnProd(activeId) {
        document.querySelectorAll("#btnProdByDate, #btnProdByType, #btnProdByGroupModel").forEach(btn => {
            btn.classList.remove("active");
        });
        document.getElementById(activeId).classList.add("active");
    }

    // Hiển thị bảng theo hash trong URL
    function showTableByHash(hash) {
    const tableDate = document.getElementById("tableProdByDate");
    const tableType = document.getElementById("tableProdByType");
    const tableGroupModel = document.getElementById("tableProdByGroupModel");

    // Ẩn hết
    tableDate.classList.add("hidden");
    tableType.classList.add("hidden");
    tableGroupModel.classList.add("hidden");

    // Mặc định
    let mode = "type";
    if(hash === "#tableProdByDate") {
        tableDate.classList.remove("hidden");
        setActiveBtnProd("btnProdByDate");
        mode = "date";
    } else if(hash === "#tableProdByGroupModel") {
        tableGroupModel.classList.remove("hidden");
        setActiveBtnProd("btnProdByGroupModel");
        mode = "group_model";
    } else {
        tableType.classList.remove("hidden");
        setActiveBtnProd("btnProdByType");
        mode = "type";
    }

    // Update chart sản lượng theo mode
    updateProdChart(mode);
}

// Chạy khi hash thay đổi (người dùng click phân trang)
window.addEventListener("hashchange", function() {
    showTableByHash(window.location.hash);

    // Cuộn tới phần biểu đồ
    const chartSection = document.getElementById("chart-section");
    if (chartSection) {
        chartSection.scrollIntoView({ behavior: "smooth" });
    }
});

let hash = window.location.hash;
if (hash) {
    showTableByHash(hash);
} else {
    // Nếu không có hash, thì để mặc định hiển thị Model
    updateProdChart("GroupModel");
    setActiveBtnProd("btnProdByGroupModel");
}
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (Toàn bộ code Chart.js cũ giữ nguyên) ...
        
        const reportUrl = "{% url 'production_report' %}"; // URL của view báo cáo

        /**
         * Hàm tải dữ liệu phân trang bằng AJAX
         * @param {number} pageNumber - Trang cần tải
         * @param {string} tableId - ID của bảng (ví dụ: 'tableProdByDate')
         */
        function loadPage(pageNumber, tableId) {
            const startDate = document.getElementById('id_start_date').value;
            const endDate = document.getElementById('id_end_date').value;
            
            // Xây dựng URL với các tham số lọc và phân trang
            const url = `${reportUrl}?start_date=${startDate}&end_date=${endDate}&page=${pageNumber}&table=${tableId}`;
            
            // Xác định container cha (DIV) để thay thế HTML
            let contentContainerId = '';
            if (tableId === 'tableProdByDate') contentContainerId = 'daily-table-content';
            else if (tableId === 'tableProdByType') contentContainerId = 'type-table-content';
            else if (tableId === 'tableProdByGroupModel') contentContainerId = 'group-model-table-content';

            const container = document.getElementById(contentContainerId);
            if (!container) return;
            
            // Hiển thị trạng thái loading
            container.innerHTML = '<p style="text-align: center; padding: 20px;">Đang tải dữ liệu...</p>';
            
            fetch(url, {
                headers: {
                    // Header chuẩn để Django nhận biết đây là yêu cầu AJAX
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Thay thế nội dung bảng và phân trang bằng HTML mới
                container.innerHTML = data.html; 
                
                // Cập nhật hash trong URL để giữ trạng thái cho lần tải lại trang
                history.replaceState(null, null, `#${data.table_id}`); 

                // Cuộn mượt đến bảng
                const tableDiv = document.getElementById(data.table_id);
                if (tableDiv) {
                    tableDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(error => {
                console.error('Lỗi khi tải trang AJAX:', error);
                container.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">Lỗi khi tải dữ liệu phân trang.</p>';
            });
        }

        // --- Gán sự kiện cho tất cả các link phân trang (Sử dụng Event Delegation) ---
        // Gán sự kiện cho body hoặc container tĩnh để bắt click trên các link phân trang được tạo mới
        document.body.addEventListener('click', function(e) {
            // Kiểm tra xem click có phải vào link phân trang AJAX không
            if (e.target.classList.contains('page-link')) {
                e.preventDefault(); // Ngăn hành vi mặc định của link
                const pageNumber = e.target.getAttribute('data-page');
                const tableId = e.target.getAttribute('data-table');
                if (pageNumber && tableId) {
                    loadPage(pageNumber, tableId);
                }
            }
        });
        
        // --- Cập nhật hàm showTableByHash (Giữ nguyên logic ẩn/hiện, loại bỏ logic cuộn) ---
        function showTableByHash(hash) {
            const tableDate = document.getElementById("tableProdByDate");
            const tableType = document.getElementById("tableProdByType");
            const tableGroupModel = document.getElementById("tableProdByGroupModel");

            tableDate.classList.add("hidden");
            tableType.classList.add("hidden");
            tableGroupModel.classList.add("hidden");

            let mode = "group_model";
            let tableId = "tableProdByGroupModel";

            if(hash === "#tableProdByDate") {
                tableId = "tableProdByDate";
                tableDate.classList.remove("hidden");
                setActiveBtnProd("btnProdByDate");
                mode = "date";
            } else if(hash === "#tableProdByType") {
                tableId = "tableProdByType";
                tableType.classList.remove("hidden");
                setActiveBtnProd("btnProdByType");
                mode = "type";
            } else { // Mặc định là GroupModel
                tableId = "tableProdByGroupModel";
                tableGroupModel.classList.remove("hidden");
                setActiveBtnProd("btnProdByGroupModel");
                mode = "group_model";
            }
            
            // Cập nhật biểu đồ
            if (!isPagination) {
                updateProdChart(mode);
            }
                    
            // **Quan trọng:** Gọi AJAX để tải trang đầu tiên của bảng khi người dùng chuyển tab/loại báo cáo
            // loadPage(1, tableId); 
            // KHÔNG GỌI loadPage(1, tableId) ở đây, vì dữ liệu trang 1 đã được render sẵn bằng Django
            
            // Cuộn mượt (giữ lại code cuộn mượt ban đầu nếu cần)
            const el = document.querySelector(hash);
            if(el) el.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ... (Các hàm và sự kiện Chart.js khác giữ nguyên) ...

        // Chạy khi hash thay đổi (người dùng click vào nút chọn bảng)
        window.addEventListener("hashchange", function() {
            showTableByHash(window.location.hash, true);
        });

        // Khởi tạo ban đầu
        let hash = window.location.hash;
        if (hash) {
            showTableByHash(hash);
        } else {
            // Nếu không có hash, thì để mặc định hiển thị GroupModel
            updateProdChart("group_model");
            setActiveBtnProd("btnProdByGroupModel");
        }
    });
</script>
{% endblock %}
